module.exports =
class StubCarrier
  constructor: ->
    @messages = []

    @_idleFuncs = []
    @_idleTimer = null
    @_resetIdleTimer()

  pipe: (@service) ->
    return this

  simulate: (message, callback) ->
    if callback
      @_resetIdleTimer()
      @onidle(callback)
    @service.onmessage(message)

  send: (message) ->
    @messages.push(message)
    @_resetIdleTimer()

  onidle: (func) ->
    @_idleFuncs.push(func)

  _resetIdleTimer: ->
    if @_idleTimer
      clearTimeout(@_idleTimer)
    @_idleTimer = setTimeout(@_handleIdle.bind(this), 1)

  _handleIdle: ->
    funcs = @_idleFuncs
    @_idleFuncs = []
    funcs.forEach((func) => func())
