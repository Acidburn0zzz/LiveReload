debug = require('debug')('livereload:context')
Path    = require 'path'
Session = require 'livereload-core'

RPC = require './rpc/rpc'

LRPreferences = require './services/preferences'
LRStats       = require './services/stats'

{ createApiTree } = require 'apitree'

class LiveReloadContext

  constructor: ->
    @universe = new Session.R.Universe()

    @paths = {}
    @paths.root = Path.dirname(__dirname)
    @paths.rpc  = Path.join(@paths.root, 'rpc-api')
    @paths.res  = Path.join(@paths.root, 'res')

    @apiTree = createApiTree(@paths.rpc)

    @universe.define(Session)
    @apiTree.projects.preinit(@universe)

    @session = @universe.create(Session)

    @paths.bundledPlugins = process.env.LRBundledPluginsOverride || Path.join(@paths.root, '../../plugins')
    @session.addPluginFolder @paths.bundledPlugins

  setupRpc: (transport) ->
    @rpc = new RPC(transport)

  setupRuntime: ({ @version, appDataDir }) ->
    @paths.appData = appDataDir
    debug "setupRuntime: version = #{@version}, paths.appData = #{@paths.appData}"

    @preferences = new LRPreferences(@paths.appData)
    @stats = new LRStats(@preferences)

    @session.setMonitoringFilter require('./modules/whiteblacklists').loadMonitoredFilesList(this)

module.exports = LiveReloadContext
