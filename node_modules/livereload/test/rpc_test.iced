assert = require 'assert'
Path   = require 'path'

RPC = require "../#{process.env.JSLIB or 'lib'}/rpc/rpc"
MockTransport = require "../#{process.env.JSLIB or 'lib'}/rpc/transports/mock"


describe "RPC", ->

  beforeEach ->
    @events = []
    @rpc = new RPC(new MockTransport())
    @rpc.on 'command', (message, arg, cb) => @events.push ['command', message, arg]; cb(null)
    @rpc.on 'idle',                       => @events.push ['idle']


  it "should simply serialize a message that does not have a callback", ->
    @rpc.send 'foo', 42
    assert.deepEqual @rpc.transport.messages, [['foo', 42]]
    assert.deepEqual @events, []


  it "should send a simple message without a callback", ->
    @rpc.send 'foo', 42
    assert.deepEqual @rpc.transport.messages, [['foo', 42]]
    assert.deepEqual @events, []


  it "should handle a message round-trip involving a callback", ->
    cb = => @events.push ['callback-called']
    @rpc.send 'foo', 42, cb
    assert.deepEqual @rpc.transport.messages, [['foo', 42, '$1']]
    assert.deepEqual Object.keys(@rpc.callbacks), ['$1']
    assert.deepEqual @events, []

    @rpc.transport.simulate ['$1', 24]
    assert.deepEqual @events, [['callback-called']]


  it "should emit 'command' when a command message is received", (done) ->
    @rpc.transport.simulate ['foo', 42]
    process.nextTick => process.nextTick =>
      assert.deepEqual @rpc.transport.messages, []
      assert.deepEqual @events, [['command', 'foo', 42], ['idle']]
      done()


describe "RPC serialization", ->
  it "should execute commands serially", (done) ->
    @events = []
    @rpc = new RPC(new MockTransport())

    @rpc.on 'command', (message, arg, cb) =>
      @events.push ['start', message, arg]
      setTimeout =>
        @events.push ['finish', message, arg]
        cb(null)
      , 50

    @rpc.transport.simulate ['foo', 1]
    @rpc.transport.simulate ['bar', 2]
    @rpc.on 'idle', =>
      assert.deepEqual @events, [['start', 'foo', 1], ['finish', 'foo', 1], ['start', 'bar', 2], ['finish', 'bar', 2]]
      done()
